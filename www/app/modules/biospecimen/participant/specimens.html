<div class="panel panel-default">
  <div class="panel-heading">
    <span translate="specimens.list">Specimens</span>
    <div class="os-action-btns" ng-if = "visit.status != 'Missed Collection'">
      <div dropdown class="btn-group">
        <button ng-if="!allowedOps || allowedOps.update" class="btn btn-primary" ng-click="collectSpecimens()">
          <span class="fa fa-plus"></span>
          <span translate="specimens.buttons.collect"> Collect </span>
        </button>
        <button class="btn btn-default dropdown-toggle">
          <span class="os-icon os-icon-assign-to"></span>
          <span translate="specimens.buttons.assign_to"> Assign To </span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right os-query-folders-dd">
          <li>
            <input ng-model="searchSpecimenList" type="text" class="form-control"
              placeholder="{{'specimen_list.search_list' | translate}}"
              ng-click="$event.stopPropagation()">
          </li>
          <li>
            <ul class="dropdown-menu-subgroup">
              <li ng-repeat="list in specimenLists | filter: searchSpecimenList"
                ng-click="addSpecimensToSpecimenList(list)">
                <a><span>{{list.name}}</span></a>
              </li>
            </ul>
          </li>
          <li class="divider"></li>
          <li ng-click="addSpecimensToSpecimenList()">
            <a translate="specimen_list.create_new_list">Create New Specimen List</a>
          </li>
        </ul>
      </div>
      <div dropdown class="os-inline-btn">
        <button class="btn btn-default dropdown-toggle">
          <span translate="common.buttons.more">More</span>
          <span class="fa fa-caret-down"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
          <li ng-click="printSpecimenLabels()">
            <a>
              <span class="os-icon os-icon-print"></span>
              <span translate="specimens.buttons.print"> Print </span>
            </a>
          </li>
          <li show-if-allowed="participantResource.deleteOpts">
            <a ng-click="deleteSpecimens()">
              <span class="os-icon os-icon-delete"></span>
              <span translate="common.buttons.delete"> Delete </span>
            </a>
          </li>
          <li show-if-allowed="participantResource.deleteOpts">
            <a ng-click="closeSpecimens()">
              <span class="fa fa-remove"></span>
              <span translate="common.buttons.close"> Close </span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="panel-body">
    <div ng-if="!specimens || specimens.length == 0">
      <span translate="specimens.no_specimens_to_show">No Specimens to Show</span>
    </div>
    <div class="os-table os-table-fixed os-table-tree" ng-class="{'os-spmn-hide-options': view != 'list'}"
      ng-if="specimens && specimens.length > 0">
      <div class="os-table-head">
        <div class="row">
          <div class="col col-xs-5">
            <div class="clearfix">
              <div class="pull-left os-select-specimen-cb" ng-if="visit.status != 'Missed Collection'">
                <os-checkbox ng-model="selection.all" ng-change="toggleAllSpecimenSelect()"></os-checkbox>
              </div>
              <div class="pull-left" style="padding-left: 40px;">
                <span translate="specimens.description"> Description </span>
              </div>
            </div>
          </div>
          <div class="col col-xs-3" translate="specimens.label">Label</div>
          <div class="col col-xs-3" translate="specimens.location">Container</div>
          <div class="col col-xs-1">&nbsp;</div>
        </div>
      </div>
      <div class="os-table-body">
        <div ng-class="{'os-inplace-form-edit-po': parentSpecimen == specimen}"
          ng-repeat="specimen in specimens | openedTreeNodes">        

          <div class="row title" ng-class="{'selected': specimen.selected}">
            <div class="col col-xs-5">
              <div class="clearfix">
                <div class="os-select-specimen-cb" ng-hide="specimen.status == 'Missed Collection'">
                  <os-checkbox ng-change="toggleSpecimenSelect(specimen)" ng-model="specimen.selected"></os-checkbox>
                </div>

                <div style="margin-left: 12px;">
                  <div ng-style="{'padding-left': (specimen.hasChildren ? specimen.depth * 20 : specimen.depth * 20 + 16) + 'px'}">
                    <a ng-if="specimen.hasChildren && specimen.isOpened" 
                       class="fa fa-chevron-circle-down"
                       ng-click="closeSpecimenNode(specimen)">
                    </a>
                    <a ng-if="specimen.hasChildren && !specimen.isOpened" 
                       class="fa fa-chevron-circle-right"
                       ng-click="openSpecimenNode(specimen)">
                    </a>

                    <span class="fa fa-circle"
                      ng-class="{'os-status-collected': specimen.status == 'Collected',
                                 'os-status-pending': specimen.status == 'Pending' || !specimen.status,
                                 'os-status-not-collected': specimen.status == 'Missed Collection',
                                 'os-status-closed': specimen.activityStatus == 'Closed'}">
                    </span>

                    <a ui-sref="specimen-detail.overview(
                                  {eventId: visit.eventId, visitId: visit.id, specimenId: specimen.id, srId: specimen.reqId})">
                      <os-specimen-desc specimen="specimen"></os-specimen-desc>
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col col-xs-3" ng-switch on="!!specimen.label">
              <span ng-switch-when="true">{{specimen.label}}</span>
              <span ng-switch-default>
                <span ng-if="!!specimen.reqLabel">{{specimen.reqLabel}}</span>
                <span ng-if="!specimen.reqLabel" translate="pvs.not_specified"></span>
              </span>
            </div>
            <div class="col col-xs-3" ng-if="specimen.storageLocation.name">
              <span>{{specimen.storageLocation.name}}</span>
              <span ng-if="!!specimen.storageLocation.positionX && !!specimen.storageLocation.positionY">
                : ({{specimen.storageLocation.positionY}}, {{specimen.storageLocation.positionX}})
              </span>
            </div>
            <div class="col col-xs-3" ng-if="!specimen.storageLocation.name">
              <span>Virtual</span>
            </div>
            <div class="col col-xs-1 os-more-options">
              <div dropdown ng-if="!selection.any">
                <button type="button" class="dropdown-toggle">
                  <span class="fa fa-ellipsis-v"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                  <li>
                    <a ui-sref="specimen-detail.overview(
                                  {eventId: visit.eventId, visitId: visit.id, specimenId: specimen.id, srId: specimen.reqId})">
                      <span class="os-icon os-icon-read"></span>
                      <span translate="specimens.ctx_menu.view_specimen">View Specimen</span>
                    </a>
                  </li>
                  <li ui-sref="specimen-addedit({
                                 eventId: visit.eventId, visitId: visit.id, 
                                 specimenId: specimen.id, srId: specimen.reqId})" 
                    ng-if="(!allowedOps || allowedOps.update) && specimen.activityStatus == 'Active'">
                    <a href="#">
                      <span class="os-icon os-icon-edit"></span>
                      <span translate="specimens.ctx_menu.edit_specimen">Edit Specimen</span>
                    </a>
                  </li>
                  <li class="divider"></li>
                  <li ng-if="(!allowedOps || allowedOps.update) && specimen.activityStatus == 'Active'">
                    <a ng-click="showCreateAliquots(specimen)">
                      <span class="os-icon os-icon-aliquots"></span>
                      <span translate="specimens.ctx_menu.create_aliquots">Create Aliquots</span>
                    </a>
                  </li>
                  <li ng-if="(!allowedOps || allowedOps.update) && specimen.activityStatus == 'Active'">
                    <a ng-click="showCreateDerivative(specimen)">
                      <span class="os-icon os-icon-derivatives"></span>
                      <span translate="specimens.ctx_menu.create_derivative">Create Derivative</span>
                    </a>
                  </li>
                  <li class="divider"></li>
                  <li ng-if="(!allowedOps || allowedOps.update) && specimen.activityStatus == 'Active'">
                    <a ui-sref="
                         specimen-detail.events({eventId: visit.eventId, visitId: visit.id, 
                           specimenId: specimen.id, srId: specimen.reqId})">
                      <span class="os-icon os-icon-calendar"></span>
                      <span translate="specimens.ctx_menu.add_event">Add Event</span>
                    </a>
                  </li>
                  <li ng-if="(!allowedOps || allowedOps.update) && specimen.activityStatus == 'Active'">
                    <a ng-click="showCloseSpecimen(specimen)">
                      <span class="fa fa-close"></span>
                      <span translate="specimens.ctx_menu.close">Close</span>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="row content" ng-if="parentSpecimen == specimen && view != 'list'">
            <div ng-if="view == 'create_aliquots'" ng-include="'aliquot_specs.html'"> </div>
            <div ng-if="view == 'create_derivatives'" ng-include="'derivative_specs.html'"> </div>
            <div ng-if="view == 'close_specimen'" ng-include="'close_specimen.html'"></div>
          </div>

        </div> 
      </div>
    </div>
  </div>
</div>

<!-- Aliquot Creation Form -->
<script type="text/ng-template" id="aliquot_specs.html">
  <div>
    <form name="aliquotForm" os-form-validator="aliquotForm" novalidate>
      <div class="clearfix">
        <div class="col-xs-12">
          <ul class="os-key-values os-two-cols">
            <li class="item">
              <strong class="key key-sm" translate="specimens.available_qty">Available Quantity:</strong>
              <span class="value value-md">{{parentSpecimen.availableQty}}</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-3">
          <div class="form-group">
            <input name="noOfAliquots" ng-model="aliquotSpec.noOfAliquots" 
              os-md-input class="form-control" type="text" placeholder="{{'specimens.aliquot_cnt' | translate}}"
              ng-required="!aliquotSpec.qtyPerAliquot" ng-pattern="/^[1-9][0-9]*$/">
            <div os-field-error field="aliquotForm.noOfAliquots"></div>
          </div>
        </div>

        <div class="col-xs-3">
          <div class="form-group">
            <input name="qtyPerAliquot" ng-model="aliquotSpec.qtyPerAliquot" 
              os-md-input class="form-control" type="text" placeholder="{{'specimens.qty_per_aliquot' | translate}}"
              ng-required="!aliquotSpec.noOfAliquots" 
              ng-pattern="/^([1-9][0-9]*(\.([0-9]{1,2}))?)$|^([0]\.([0-9]{1,2}))$/" 
              ng-model-options="{allowInvalid: 'true'}">
            <div os-field-error field="aliquotForm.qtyPerAliquot"></div>
          </div>
        </div>

        <div class="col-xs-3">
          <div os-md-input ng-model="aliquotSpec.createdOn" placeholder="{{'specimens.created_on' | translate}}">
            <input name="createdOn" ng-model="aliquotSpec.createdOn" class="form-control" type="text"
              datepicker-popup="{{global.dateFmt}}" show-button-bar="true" 
              is-open="createdOn.isOpen" ng-focus="createdOn.isOpen=true"
              required placeholder="{{'specimens.created_on' | translate}}">
            <div os-field-error field="aliquotForm.createdOn"></div>
          </div>
        </div>

        <div class="col-xs-2">
          <timepicker class="os-time-no-wheels" os-md-input ng-model="aliquotSpec.createdOn" show-meridian="false">
          </timepicker>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-12 os-spmn-close-parent">
          <div class="checkbox"> 
            <os-checkbox ng-model="aliquotSpec.closeParent"></os-checkbox>
          </div>
          <div class="message">
            <span translate="specimens.close_parent_q">Do you want to close parent specimen?</span>
          </div>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-12">
          <button type="submit" class="btn btn-success" os-form-submit="collectAliquots()" local-form="true">
            <span translate="specimens.buttons.collect_aliquots">Collect Aliquots</span>
          </button>
          <a class="btn os-btn-text-secondary" os-form-cancel="revertEdit()">
            <span translate="common.buttons.cancel">Cancel</span>
          </a>
        </div>
      </div>
    </form>
  </div>
</script>

<!-- Derivative Creation Form -->
<script type="text/ng-template" id="derivative_specs.html">
  <div>
    <form name="derivativeForm" os-form-validator="derivativeForm" novalidate>
      <div class="clearfix">
        <div class="os-col-30">
          <div class="form-group">
            <os-select name="specimenClass" on-change="loadSpecimenTypes(derivative.specimenClass)" 
              ng-model="derivative.specimenClass" list="specimenClasses"
              os-md-input placeholder="{{'specimens.class' | translate}}" required>
            </os-select>
            <div os-field-error field="derivativeForm.specimenClass"></div>
          </div>
        </div>

        <div class="os-col-30">
          <div class="form-group">
            <os-select name="specimenType" ng-model="derivative.type" list="specimenTypes"
              os-md-input placeholder="{{'specimens.type' | translate}}" required>
            </os-select>
            <div os-field-error field="derivativeForm.specimenType"></div>
          </div>
        </div>
  
        <div class="os-col-30">
          <div class="form-group">
            <input name="label" ng-model="derivative.label" os-md-input class="form-control"
              type="text" placeholder="{{'specimens.label' | translate}}" 
              ng-required="!cpr.derivativeLabelFmt">
            <div os-field-error field="derivativeForm.label"></div>
          </div>
        </div>
      </div>
 
      <div class="clearfix">
        <div class="os-col-30">
          <div class="form-group">
            <input name="quantity" ng-model="derivative.initialQty" os-md-input class="form-control" 
              type="text" placeholder="{{'specimens.qty' | translate}}" required 
              ng-pattern="/^([0-9]+|[0-9]*\.[0-9]+)$/">
            <div os-field-error field="derivativeForm.quantity"></div>
          </div>
        </div>

        <div class="os-col-30" ng-if="derivative.specimenClass == 'Molecular'">
          <div class="form-group">
            <input name="concentration" ng-model="derivative.concentration" os-md-input class="form-control" 
              type="text" placeholder="{{'specimens.concentration' | translate}}" 
              ng-pattern="/^([0-9]+|[0-9]*\.[0-9]+)$/" ng-model-options="{allowInvalid: 'true'}">
            <div os-field-error field="derivativeForm.concentration"></div>
          </div>
        </div>

        <div ng-class="{'os-col-50': derivative.specimenClass != 'Molecular', 
                        'os-col-40': derivative.specimenClass == 'Molecular'}">
          <div class="form-group">
            <os-storage-position os-md-input entity="derivative" cp-id="cpr.cpId"></os-storage-position>
          </div>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="os-col-30">
          <div os-md-input ng-model="derivative.createdOn" placeholder="{{'specimens.created_on' | translate}}">
            <input name="createdOn" ng-model="derivative.createdOn" class="form-control" type="text"
              datepicker-popup="{{global.dateFmt}}" show-button-bar="true" 
              is-open="createdOn.isOpen" ng-focus="createdOn.isOpen=true"
              required placeholder="{{'specimens.created_on' | translate}}">
            <div os-field-error field="derivativeForm.createdOn"></div>
          </div>
        </div>

        <div class="os-col-15">
          <timepicker class="os-time-no-wheels" os-md-input ng-model="derivative.createdOn" show-meridian="false">
          </timepicker>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-12 os-spmn-close-parent">
          <div class="checkbox"> 
            <os-checkbox ng-model="derivative.closeParent"></os-checkbox>
          </div>
          <div class="message">
            <span translate="specimens.close_parent_q">Do you want to close parent specimen?</span>
          </div>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-12">
          <button type="submit" class="btn btn-success" os-form-submit="createDerivative()"
            translate="specimens.buttons.create_derivative">
            Create Derivative
          </button>
          <a class="btn os-btn-text-secondary" ng-click="revertEdit()" translate="common.buttons.cancel">
            Cancel
          </a>
        </div>
      </div>
    </form>
  </div>
</script>

<script type="text/ng-template" id="close_specimen.html">
  <div>
    <form name="closeSpecForm" os-form-validator="closeSpecForm" novalidate>
      <div class="clearfix">
        <div class="col-xs-12">
          <div class="form-group">
            <input name="reason" ng-model="specStatus.reason" os-md-input class="form-control" 
              type="text" placeholder="{{'specimens.reason_for_closing' | translate}}">
            <div os-field-error field="closeSpecForm.reason"></div>
          </div>
        </div>
      </div>

      <div class="form-group clearfix">
        <div class="col-xs-4">
          <button type="submit" class="btn btn-success" os-form-submit="closeSpecimen()" 
            translate="common.buttons.close">
            Close
          </button>
          <a class="btn os-btn-text-secondary" ng-click="revertEdit()" translate="common.buttons.cancel">
            Cancel
          </a>
        </div>
      </div>
    </form>
  </div>
</script>
